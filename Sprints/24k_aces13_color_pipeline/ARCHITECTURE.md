# Sprint 24k — ARCHITECTURE (ACES 1.3 validator-first)

## Why this exists
Sprint 24k is the “cinema-grade” foundation: a **single reference-correct color pipeline** that enables one person with an iPhone and a Mac to produce reliable SDR + HDR masters.

This sprint is explicitly **validator-first**: we lock down reference behavior (ACES 1.3) and then optimize/approximate behind policy tiers without changing the intended look.

## Core concept: One truth, many budgets
- **Truth pipeline (Studio)**: reference-correct ACES 1.3 behavior.
- **Policy tiers** (consumer/creator/studio): control approximation/perf/precision, but must remain bounded against Studio.

As of 2025-12-23, the Studio “truth” for display rendering is implemented via **authoritative OCIO-baked LUT artifacts** (not bespoke shader approximations).

## Shipping contracts we must respect (24h/24j)
- The RenderGraph is compiled by `TimelineCompiler` and executed by `MetalSimulationEngine`.
- Working format defaults to float intermediates; non-float formats are conservative and generally reserved for terminal outputs.
- Mixed-resolution behavior is controlled by `RenderRequest.edgePolicy` (engine may insert resize adapters).
- `RenderNode.OutputSpec` controls per-node output sizing (full/half/quarter/fixed).

## Rendering color architecture (conceptual)
### 1) Ingest (IDT)
- Input camera encoding → ACEScg linear.
- Sprint 24k assumes **Option A: iPhone Log** as the primary capture path.
- The IDT must be explicit and testable; “whatever the OS did” is not a stable truth source.

Shipping invariant (today): the compiler inserts an IDT per clip before any clip FX.

### 2) Working space (internal)
- Everything in the render graph runs in **ACEScg linear**.
- Masks, grades, blends, VFX, LUTs, text: operate in ACEScg unless explicitly documented otherwise.

### 3) Creative layer (optional)
- LMT (look) is separate from the reference RRT/ODT chain.
- Policy tiers cannot introduce a different look; they can only approximate the same look.

### 4) Viewing pipeline
- **Reference**: ACES 1.3 RRT + ODTs.
- Targets:
  - SDR Rec.709 (100 nits)
  - HDR PQ (1000 nits)

Shipping invariant (today): the compiler appends exactly one ODT at the end of the graph and makes it the root node.
Sprint 24k extends this by adding an HDR ODT option while keeping SDR Rec.709 as the default until validators pass.

#### Implementation mapping (Studio)
- `official OCIO config` → baked `.cube` LUT resources → GPU `lut_apply_3d`.
- Compiler selects LUT ODTs for `RenderPolicyTier.studio` when available.

### 5) Validation harness
- Deterministic procedural generators (SMPTE, ramps, zone plates)
- Reference EXRs (ColorChecker in ACES2065-1)
- CTL library as a normative reference input (where feasible)
- Tests assert:
  - output correctness vs goldens
  - bounded error across tiers
  - no banding/tint regressions on ramps

#### Historical metrics logging
To make optimization repeatable, we log perf + correctness metrics:
- Append-only JSONL: `test_outputs/perf/perf.jsonl`
- Per-run report folder: `test_outputs/metrics/<RUN_ID>/` generated by `scripts/run_metrics.sh`

## Asset layout
- Canonical reference assets live in `Tests/Assets/acescg/` (see README there).
- Real-world footage used for integration lives in `Tests/Assets/VideoEdit/`.

For real-world footage, tests should rely on an ingest sidecar (operator-declared truth) rather than container tags.

## Known current gaps in implementation (tracked by this sprint)
- Current shader path contains placeholders and non-ACES HDR behavior; Sprint 24k replaces those with ACES 1.3 reference behavior.
- PQ EOTF/OETF implementations must be stable and branchless where possible.

## Non-goals
- Backwards compatibility with old looks.
- Multiple “creative” tone curves presented as equal defaults.
- Shipping a UI overhaul; this sprint is correctness + validation.

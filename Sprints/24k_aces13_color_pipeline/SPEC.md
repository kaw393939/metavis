# Sprint 24k — SPEC (ACES 1.3 + SDR/HDR outputs)

## Scope
This spec defines the **normative behavior** of MetaVis color processing for Sprint 24k.

## Working space
- Internal working space is **ACEScg linear**.
- Any exceptions must be explicitly documented and tested.

Shipping invariant (today): TimelineCompiler inserts an IDT per clip and appends exactly one ODT at the end; the ODT is the graph root.

## Ingest (Option A: iPhone log)
- Primary input profile for this sprint: **iPhone log footage** (recorded to ProRes).
- The ingest contract requires explicit declaration of:
  - camera primaries/gamut
  - transfer function (log curve)
  - legal/full range expectations

For our initial real-world integration clip we assume:
- Recorder: Blackmagic Cam (iPhone)
- Codec: Apple ProRes 422 HQ
- Gamma/curve: **Apple Log (HDR)**

If a clip is missing reliable metadata, it may still be used for **integration** regressions, but not as numeric ground truth.

## Reference pipeline
### ACES 1.3 components
- Reference behavior is ACES 1.3-style:
  - Reference Gamut Compression (RGC)
  - RRT (including sweeteners: red modifier, glow)
  - ODT(s) for target displays

### Normative reference strategy (Studio)
**Studio reference truth** for display rendering is now defined as:
`official ACES 1.3 OCIO config` → `ociobakelut` → committed `.cube` LUT resources → GPU `lut_apply_3d`.

Rationale:
- We already have a stable 3D LUT GPU kernel and `.cube` parsing pipeline.
- OCIO artifacts are an authoritative, reproducible reference for the ACES 1.3 display/view transforms.
- It avoids introducing a bespoke shader approximation and calling it “ACES”.

### SDR target
- SDR output target: **SDR display rendering** (ACES 1.3 display/view baked to a 33³ `.cube`).
  - Note: the artifact is commonly labeled via OCIO as “sRGB - Display / ACES 1.0 - SDR Video”.

### HDR target
- HDR output target: **PQ (ST 2084)**, mastered to **1000 nits**.
- HDR path must not use ad-hoc “Reinhard-like” tonemapping as the default.

Integration note (current implementation):
- `studio` uses a committed OCIO-baked LUT for PQ1000 display rendering (33³ `.cube`).
- `creator/consumer` may use shader-based transforms (faster/legacy) until we explicitly promote LUT usage for those tiers.

Integration rule for a smooth rollout:
- Introduce HDR as an **opt-in display target** (new ODT selection) while preserving SDR Rec.709 as the default until validators pass.

## Policy tiers
- `studio` is the reference truth used for goldens.
- `creator` and `consumer` may use approximations for speed (precision, sampling, bandwidth) but must remain within defined tolerances.

Policy tiers must not intentionally change the creative look (they control approximation/performance only).

In practice today:
- `studio`: prefer OCIO-baked LUT ODTs (SDR + HDR PQ1000)
- `creator/consumer`: may fall back to shader ODT implementations

## Validation requirements
- Golden-based checks (hash or pixel metrics) for deterministic procedural inputs.
- Metric-based checks for reference images:
  - patch sampling + ΔE bounds for ColorChecker
  - ramp linearity + tint bounds for grayscale
  - clipping/roll-off behavior for highlight ramps

### Required repeatable protocol
All perf + color-cert results must be logged in a historical, machine-readable form:
- Append-only log: `test_outputs/perf/perf.jsonl`
- Per-run report folder: `test_outputs/metrics/<RUN_ID>/` (generated by `scripts/run_metrics.sh`)

## Deliverables (out of this sprint)
- This sprint outputs correctness + tests. Any export/container work is only included if required to preserve correct HDR metadata end-to-end.

## Compiler/registry constraints (24h)
- Clip-level effects are limited by `compilationDomain: clip` and supported input ports (`source`/`input` and `faceMask`).
- Multi-input effects (mask/lut/depth/history) must remain graph-level until the compiler can source those inputs.
